@{
    Layout = "~/Views/Shared/_Layout.cshtml"; // Optional if you use a shared layout
}

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<style>
    /* Shrink the routing instructions container */
    .leaflet-routing-container {
        font-size: 12px; /* Smaller font size */
        background-color: rgba(255, 255, 255, 0.8); /* Transparent background */
        width: 200px; /* Adjust width */
        padding: 5px;
        position: absolute;
        top: 10px; /* Place at the top */
        right: 10px; /* Place at the right */
        z-index: 1000;
        border-radius: 5px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); /* Add subtle shadow */
    }

        /* Hide unnecessary elements inside the routing container */
        .leaflet-routing-container .leaflet-routing-instructions {
            display: none; /* Hide detailed instructions */
        }

        /* Optional: Hide alternative routes */
        .leaflet-routing-container .leaflet-routing-alt {
            display: none;
        }

    /* Style for alert messages */
    #message-container {
        margin-bottom: 10px;
    }
</style>

<!-- Alert Messages Section -->
@if (TempData["LoginMessage"] != null)
{
<div class="alert alert-success alert-dismissible fade show" role="alert">
    @TempData["LoginMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
}

<br />
<br />

<!-- Header Section -->
<header class="bg-primary text-white text-center py-5 rounded-3">
    <div class="container">
        <h1>Welcome to the Cab Booking System</h1>
        <p>Book your cab with ease and comfort!</p>
    </div>
</header>

<!-- Booking Form Section -->
<section id="booking-form" class="py-5">
    <div class="container">
        <h2 class="text-center mb-4">Book a Cab Now!</h2>

        <div id="message-container" class="text-center"></div> <!-- For error/success messages -->

        <form action="/Home/Search" method="post">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="pickup">Pickup Location:</label>
                        <input type="text" id="pickup" name="PickupLocation" class="form-control" placeholder="Click on the map to select pickup location" readonly required />
                    </div>
                    <br />
                    <div class="form-group">
                        <label for="drop">Drop Location:</label>
                        <input type="text" id="drop" name="DropLocation" class="form-control" placeholder="Click on the map to select drop location" readonly required />
                    </div>
                    <br />
                    <!-- Swap Button -->
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" id="swap-btn" onclick="swapLocations()">Swap Locations</button>
                    </div>
                    <br />
                    <div class="form-group">
                        <label for="persons">Total Persons:</label>
                        <input type="number" id="persons" name="TotalPersons" class="form-control" placeholder="Enter the total number of persons" required />
                    </div>
                    <br />
                    <div class="form-group">
                        <label for="distance">Distance (km):</label>
                        <input type="number" id="distance" name="Distance" class="form-control" placeholder="Distance will be calculated" readonly />
                    </div>
                    <br />
                    <div class="form-group">
                        <label for="time">Booking Time:</label>
                        <input type="datetime-local" id="time" name="BookingTime" class="form-control" required />
                    </div>
                </div>
                <div class="col-md-6">
                    <center><label for="map">Select Locations on Map:</label></center>
                    <div id="map" style="height: 400px;"></div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary">Search Cabs</button>
            </div>
        </form>
    </div>
</section>

<!-- Features Section -->
<section id="features" class="py-5 bg-light">
    <div class="container">
        <h2 class="text-center">Why Choose Us?</h2>
        <div class="row text-center mt-4">
            <div class="col-md-4">
                <h4>Reliable and Trusted Drivers</h4>
                <p>Our drivers are experienced and verified.</p>
            </div>
            <div class="col-md-4">
                <h4>Wide Range of Cabs</h4>
                <p>We provide a wide variety of cabs to suit your needs.</p>
            </div>
            <div class="col-md-4">
                <h4>Affordable Pricing</h4>
                <p>Get the best rates for all your rides.</p>
            </div>
        </div>
    </div>
</section>

<!-- Footer Section -->
<footer class="py-4 bg-dark text-white text-center">
    <div class="container">
        <p>&copy; 2024 Cab Booking System. All rights reserved.</p>
    </div>
</footer>

<script>
    // Initialize the map over India
    var map = L.map('map').setView([20.5937, 78.9629], 5);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data © OpenStreetMap contributors'
    }).addTo(map);

    var pickupMarker, dropMarker, route;
    var settingPickup = false; // Initial state

    // Display messages (alerts)
    function displayMessage(message, messageType = 'warning') {
        var messageContainer = document.getElementById('message-container');
        var messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${messageType} alert-dismissible fade show`;
        messageDiv.role = 'alert';
        messageDiv.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
        messageContainer.appendChild(messageDiv);

        setTimeout(function () {
            if (messageDiv) {
                messageDiv.classList.remove('show');
                setTimeout(() => {
                    messageDiv.remove();
                }, 500);
            }
        }, 2000);
    }

    // Remove a marker from the map
    function removeMarker(marker) {
        if (marker) {
            map.removeLayer(marker);
        }
    }

    // Reset map and clear fields
    function resetMapToDefault() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                map.setView([lat, lng], 13);

                removeMarker(pickupMarker);
                pickupMarker = L.marker([lat, lng]).addTo(map)
                    .bindPopup('Pickup location set here!')
                    .openPopup();

                getAreaName(lat, lng, function (areaName) {
                    document.getElementById('pickup').value = areaName;
                });

                removeMarker(dropMarker);
                document.getElementById('drop').value = '';
                if (route) map.removeControl(route);
                document.getElementById('distance').value = '';
            });
        } else {
            displayMessage('Geolocation is not supported by this browser.', 'danger');
        }
    }

    // Validate location in India
    function validateLocationInIndia(lat, lng, callback) {
        var url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                var address = data.address;
                if (address && address.country_code !== 'in') {
                    displayMessage("Selected location is outside India. Booking not allowed.", 'danger');
                    resetMapToDefault();
                    callback(false);
                } else {
                    callback(true, data.display_name);
                }
            });
    }

    // Reverse geocoding to get area name
    function getAreaName(lat, lng, callback) {
        var url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                callback(data.display_name);
            });
    }

    // Create a route
    function createRoute(pickupLatLng, dropLatLng) {
        if (route) map.removeControl(route);

        route = L.Routing.control({
            waypoints: [
                L.latLng(pickupLatLng.lat, pickupLatLng.lng),
                L.latLng(dropLatLng.lat, dropLatLng.lng)
            ],
            routeWhileDragging: true
        }).addTo(map);

        route.on('routesfound', function (e) {
            var distance = e.routes[0].summary.totalDistance / 1000; // distance in km
            document.getElementById('distance').value = distance.toFixed(2);

            if (distance > 300) {
                displayMessage("Distance is more than 300 km. Booking not allowed.", 'danger');
                resetMapToDefault();
            }
        });
    }

    // Map click event to select pickup and drop locations
    map.on('click', function (e) {
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;

        if (!settingPickup) {
            // Set Pickup Location
            removeMarker(pickupMarker);
            pickupMarker = L.marker([lat, lng]).addTo(map)
                .bindPopup('Pickup location set here!')
                .openPopup();

            validateLocationInIndia(lat, lng, function (isValid, areaName) {
                if (isValid) {
                    document.getElementById('pickup').value = areaName;
                    settingPickup = true; // Now allow setting drop location
                }
            });
        } else {
            // Set Drop Location
            removeMarker(dropMarker);
            dropMarker = L.marker([lat, lng]).addTo(map)
                .bindPopup('Drop location set here!')
                .openPopup();

            validateLocationInIndia(lat, lng, function (isValid, areaName) {
                if (isValid) {
                    document.getElementById('drop').value = areaName;

                    var pickupLatLng = pickupMarker.getLatLng();
                    var dropLatLng = dropMarker.getLatLng();
                    createRoute(pickupLatLng, dropLatLng);
                }
            });
        }
    });

    // Function to swap pickup and drop locations
    function swapLocations() {
        var pickupInput = document.getElementById('pickup');
        var dropInput = document.getElementById('drop');
        var tempValue = pickupInput.value;
        pickupInput.value = dropInput.value;
        dropInput.value = tempValue;

        if (pickupMarker && dropMarker) {
            var pickupLatLng = pickupMarker.getLatLng();
            var dropLatLng = dropMarker.getLatLng();

            // Swap the markers
            var tempLatLng = pickupLatLng;
            pickupMarker.setLatLng(dropLatLng).update();
            dropMarker.setLatLng(tempLatLng).update();

            createRoute(pickupMarker.getLatLng(), dropMarker.getLatLng());
        }
    }

    // Reset map when page loads
    document.addEventListener("DOMContentLoaded", function () {
        resetMapToDefault();
    });
</script>
